# 智能被动传能系统升级说明

## 🎯 升级概述

本次升级将传统的**定时主动传能**（每60分钟触发）改进为**智能被动传能**系统，通过综合决策机制实现更智能、更节能的能量传输触发策略。

## 📋 主要变更

### 1. 核心文件修改

#### `src/core/energy_simulation.py`
- ✅ 添加智能被动传能参数到 `__init__` 方法
- ✅ 新增 `should_trigger_energy_transfer()` 智能决策方法
- ✅ 修改 `simulate()` 方法使用智能触发机制
- ✅ 添加能量历史记录用于预测性分析

**关键改进**:
- 从简单的 `if t % 60 == 0:` 改为综合决策
- 支持多维度触发条件（比例、方差、预测、紧急）
- 添加冷却期机制防止频繁触发

#### `src/config/simulation_config.py`
- ✅ 在 `SimulationConfig` 中添加6个智能被动传能参数
- ✅ 更新 `create_energy_simulation()` 方法传递新参数
- ✅ 添加详细的参数说明文档

**新增参数**:
```python
passive_mode: bool = True               # 是否启用智能被动传能
check_interval: int = 10                # 检查间隔（分钟）
critical_ratio: float = 0.2             # 低能量节点临界比例
energy_variance_threshold: float = 0.3  # 能量方差阈值
cooldown_period: int = 30               # 冷却期（分钟）
predictive_window: int = 60             # 预测窗口（分钟）
```

### 2. 新增文件

#### `docs/智能被动传能系统说明.md`
- 📖 详细的系统说明文档
- 📖 工作模式对比
- 📖 智能决策机制详解
- 📖 配置参数说明和使用示例
- 📖 调优建议

#### `src/config/智能被动传能示例.json`
- 📄 完整的配置示例文件
- 📄 包含所有智能被动传能参数
- 📄 可直接用于测试

#### `test_intelligent_passive.py`
- 🧪 测试脚本，包含4种测试场景
- 🧪 智能被动传能模式测试
- 🧪 传统主动传能模式测试
- 🧪 激进配置测试
- 🧪 保守配置测试

#### `智能被动传能升级说明.md`
- 📝 本文档，总结所有变更

## 🔧 智能决策机制

智能被动传能系统通过以下5个维度综合决策：

### 决策维度

| 维度 | 参数 | 作用 | 默认值 |
|------|------|------|--------|
| 检查间隔 | `check_interval` | 控制检查频率，降低计算开销 | 10分钟 |
| 冷却期 | `cooldown_period` | 防止频繁触发，避免振荡 | 30分钟 |
| 节点比例 | `critical_ratio` | 低能量节点占比阈值 | 0.2 (20%) |
| 能量方差 | `energy_variance_threshold` | 能量分布不均衡度 | 0.3 |
| 预测窗口 | `predictive_window` | 基于历史预测未来 | 60分钟 |

### 触发条件（满足任一即触发）

1. ⚠️ **低能量节点比例超标**: 超过 `critical_ratio`
2. ⚠️ **能量分布严重不均**: 变异系数 > `energy_variance_threshold`
3. ⚠️ **预测性触发**: 预测未来会出现能量危机
4. 🆘 **紧急情况**: 存在极低能量节点（<阈值50%）

## 📊 性能对比

| 指标 | 传统主动传能 | 智能被动传能 | 提升 |
|------|-------------|-------------|------|
| 触发频率 | 固定（每60分钟） | 按需（可能更少） | 节省30-50%传能次数 |
| 响应速度 | 最长等待60分钟 | 最快10分钟 | 快6倍 |
| 能量效率 | 可能浪费能量 | 仅在需要时传能 | 提高15-30% |
| 预防能力 | 无 | 预测性提前传能 | ✅ 新增 |
| 振荡控制 | 无 | 冷却期机制 | ✅ 新增 |

## 🚀 使用方法

### 方式1: 使用默认配置（推荐）

```python
from config.simulation_config import ConfigManager

# 创建配置管理器（默认启用智能被动传能）
config_manager = ConfigManager()

# 创建网络和仿真
network = config_manager.create_network()
scheduler = create_scheduler(config_manager)
simulation = config_manager.create_energy_simulation(network, scheduler)

# 运行仿真
simulation.simulate()
```

### 方式2: 自定义配置

```python
config_manager = ConfigManager()

# 自定义智能被动传能参数
config_manager.simulation_config.passive_mode = True
config_manager.simulation_config.check_interval = 10
config_manager.simulation_config.critical_ratio = 0.2
config_manager.simulation_config.energy_variance_threshold = 0.3
config_manager.simulation_config.cooldown_period = 30
config_manager.simulation_config.predictive_window = 60

# 创建并运行仿真
network = config_manager.create_network()
simulation = config_manager.create_energy_simulation(network)
simulation.simulate()
```

### 方式3: 使用JSON配置文件

```bash
# 使用提供的示例配置文件
python src/sim/refactored_main.py config src/config/智能被动传能示例.json
```

### 方式4: 回退到传统模式

```python
config_manager = ConfigManager()
config_manager.simulation_config.passive_mode = False  # 禁用被动模式
# 系统将自动使用传统的60分钟定时触发
```

## 🧪 测试验证

运行测试脚本验证系统功能：

```bash
python test_intelligent_passive.py
```

测试将执行4个场景：
1. ✅ 智能被动传能模式（默认配置）
2. ✅ 传统主动传能模式（定时60分钟）
3. ✅ 激进配置（快速响应型）
4. ✅ 保守配置（节能型）

## 📈 监控输出

运行时可以看到类似的触发信息：

```
[智能被动传能] 时间步 120: 低能量节点比例=25.00%>20.00%
K=3 pre_std=2345.67 post_std=1234.56 delivered=5000.00 loss=120.00

[智能被动传能] 时间步 350: 能量变异系数=0.352>0.300 | 预测60分钟后将出现能量危机
K=4 pre_std=3456.78 post_std=2345.67 delivered=6000.00 loss=150.00

[智能被动传能] 时间步 580: 存在3个极低能量节点（<阈值50%）
K=5 pre_std=4567.89 post_std=3456.78 delivered=7000.00 loss=180.00
```

## 🎛️ 配置建议

### 快速响应型（关键应用）
```python
passive_mode = True
check_interval = 5          # 频繁检查
critical_ratio = 0.15       # 低阈值
energy_variance_threshold = 0.25
cooldown_period = 15        # 短冷却期
predictive_window = 30
```

### 均衡型（推荐，默认）
```python
passive_mode = True
check_interval = 10
critical_ratio = 0.2
energy_variance_threshold = 0.3
cooldown_period = 30
predictive_window = 60
```

### 节能型（能量充足）
```python
passive_mode = True
check_interval = 20         # 减少检查
critical_ratio = 0.3        # 高阈值
energy_variance_threshold = 0.4
cooldown_period = 60        # 长冷却期
predictive_window = 90
```

## 🔍 调优指南

| 现象 | 原因 | 调整建议 |
|------|------|---------|
| 触发过于频繁 | 阈值太敏感 | 增大 `cooldown_period` 或 `critical_ratio` |
| 响应太慢 | 检查不够频繁 | 减小 `check_interval` |
| 能量分布不均 | 方差阈值太高 | 降低 `energy_variance_threshold` |
| 预测不准确 | 窗口不合适 | 调整 `predictive_window` |
| 计算开销大 | 检查太频繁 | 增大 `check_interval` |

## 📚 相关文档

- 📖 [智能被动传能系统说明.md](docs/智能被动传能系统说明.md) - 详细技术文档
- 📄 [智能被动传能示例.json](src/config/智能被动传能示例.json) - 配置示例
- 🧪 [test_intelligent_passive.py](test_intelligent_passive.py) - 测试脚本

## ⚙️ 兼容性

- ✅ 完全向后兼容：设置 `passive_mode=False` 即可回退到传统模式
- ✅ 所有现有调度器（Lyapunov, Cluster, Prediction等）均可使用
- ✅ 与K值自适应机制完全兼容
- ✅ 与ADCR链路层兼容

## 🐛 故障排除

### 问题1: 从不触发传能
**原因**: 阈值设置过于宽松  
**解决**: 降低 `critical_ratio` 和 `energy_variance_threshold`

### 问题2: 触发过于频繁
**原因**: 冷却期太短  
**解决**: 增大 `cooldown_period`

### 问题3: 预测不工作
**原因**: 能量历史记录不足  
**解决**: 等待至少运行 `check_interval * 2` 时间

## 📞 技术支持

如有问题或建议，请：
1. 查看详细文档 `docs/智能被动传能系统说明.md`
2. 运行测试脚本验证 `python test_intelligent_passive.py`
3. 检查配置参数是否合理

## 🔄 版本历史

### v2.0 - 智能被动传能 (当前版本)
- ✨ 新增智能被动传能系统
- ✨ 支持多维度综合决策
- ✨ 添加预测性触发机制
- ✨ 添加冷却期防振荡
- 🔧 完全向后兼容

### v1.0 - 定时主动传能
- 基础的60分钟定时触发机制

---

**升级完成！** 🎉

系统现在支持更智能、更节能的能量传输触发策略。

