# æŒ‡ä»¤ä¸‹å‘åŠŸèƒ½é‡æ„æŠ¥å‘Š

## ğŸ“‹ é‡æ„æ¦‚è¿°

å°†æŒ‡ä»¤ä¸‹å‘åŠŸèƒ½ä» `EnergySimulation` ç±»è¿ç§»åˆ° `NodeInfoManager` ç±»ï¼Œå®ç°æ›´æ¸…æ™°çš„èŒè´£åˆ†ç¦»å’Œæ›´å¥½çš„é¢å‘å¯¹è±¡è®¾è®¡ã€‚

---

## ğŸ¯ é‡æ„ç›®æ ‡

### é—®é¢˜åˆ†æ

**åŸå§‹è®¾è®¡é—®é¢˜**ï¼š
- æŒ‡ä»¤ä¸‹å‘é€»è¾‘å®Œå…¨åœ¨ `EnergySimulation` ä¸­å®ç°
- `NodeInfoManager`ï¼ˆç‰©ç†ä¸­å¿ƒï¼‰åªè´Ÿè´£è¢«åŠ¨æ¥æ”¶ä¿¡æ¯ï¼Œæ²¡æœ‰ä¸»åŠ¨è¡Œä¸º
- èŒè´£åˆ†é…ä¸å¤Ÿæ¸…æ™°ï¼Œè¿åå•ä¸€èŒè´£åŸåˆ™

**ç†æƒ³è®¾è®¡**ï¼š
- `NodeInfoManager`ï¼šè´Ÿè´£ç‰©ç†ä¸­å¿ƒçš„æ‰€æœ‰è¡Œä¸ºï¼ˆæ¥æ”¶ä¿¡æ¯ã€ä¸‹å‘æŒ‡ä»¤ã€ç®¡ç†ä¿¡æ¯è¡¨ï¼‰
- `EnergySimulation`ï¼šè´Ÿè´£æ•´ä½“æµç¨‹æ§åˆ¶å’Œé…ç½®ç®¡ç†

---

## ğŸ”§ é‡æ„å®æ–½

### 1. NodeInfoManager æ–°å¢æ–¹æ³•

#### 1.1 `_collect_command_recipients(plans)` 
**èŒè´£**ï¼šä»ä¼ èƒ½è®¡åˆ’ä¸­æ”¶é›†éœ€è¦é€šçŸ¥çš„èŠ‚ç‚¹

```python
def _collect_command_recipients(self, plans):
    """
    æ”¶é›†éœ€è¦æ¥æ”¶æŒ‡ä»¤çš„èŠ‚ç‚¹
    
    ä»ä¼ èƒ½è®¡åˆ’ä¸­æå–æ‰€æœ‰å‚ä¸èŠ‚ç‚¹ï¼ˆdonorã€receiverã€relayï¼‰ï¼Œ
    è‡ªåŠ¨å»é‡ï¼Œç¡®ä¿æ¯ä¸ªèŠ‚ç‚¹åªè¢«é€šçŸ¥ä¸€æ¬¡ã€‚
    """
    notified_nodes = set()
    for plan in plans:
        # donorå’Œreceiver
        notified_nodes.add(plan['donor'])
        notified_nodes.add(plan['receiver'])
        # ä¸­ç»§èŠ‚ç‚¹ï¼ˆpathä¸­é™¤äº†èµ·ç‚¹å’Œç»ˆç‚¹çš„èŠ‚ç‚¹ï¼‰
        if 'path' in plan and len(plan['path']) > 2:
            for node in plan['path'][1:-1]:
                notified_nodes.add(node)
    return notified_nodes
```

**ç‰¹ç‚¹**ï¼š
- âœ… è‡ªåŠ¨å»é‡ï¼ˆä½¿ç”¨ `set`ï¼‰
- âœ… å®Œæ•´æ”¶é›†æ‰€æœ‰å‚ä¸èŠ‚ç‚¹ï¼ˆdonorã€receiverã€relayï¼‰
- âœ… å†…éƒ¨è¾…åŠ©æ–¹æ³•ï¼ˆ`_`å‰ç¼€ï¼‰

---

#### 1.2 `_execute_broadcast(physical_center_node, notified_nodes, command_packet_size)`
**èŒè´£**ï¼šæ‰§è¡ŒæŒ‡ä»¤å¹¿æ’­å¹¶æ‰£é™¤èƒ½é‡

```python
def _execute_broadcast(self, physical_center_node, notified_nodes, command_packet_size):
    """
    æ‰§è¡ŒæŒ‡ä»¤å¹¿æ’­å¹¶æ‰£é™¤èƒ½é‡
    
    è®¡ç®—ç‰©ç†ä¸­å¿ƒå‘æ¯ä¸ªèŠ‚ç‚¹å‘é€æŒ‡ä»¤çš„èƒ½é‡æ¶ˆè€—ï¼š
    - ä¸­å¿ƒå‘é€ï¼šE_tx
    - èŠ‚ç‚¹æ¥æ”¶ï¼šE_rx
    - åŒå‘æ‰£é™¤èƒ½é‡
    """
    total_energy = 0.0
    center_energy_cost = 0.0
    
    # ç¬¬ä¸€éï¼šè®¡ç®—æ€»èƒ½é‡æ¶ˆè€—
    for node in notified_nodes:
        # ... è®¡ç®— E_tx å’Œ E_rx ...
        center_energy_cost += E_tx
        total_energy += (E_tx + E_rx)
    
    # æ£€æŸ¥ä¸­å¿ƒèƒ½é‡æ˜¯å¦è¶³å¤Ÿ
    if physical_center_node.current_energy < center_energy_cost:
        return 0.0, False
    
    # ç¬¬äºŒéï¼šæ‰£é™¤èƒ½é‡
    physical_center_node.current_energy -= center_energy_cost
    for node in notified_nodes:
        # ... æ‰£é™¤ E_rx ...
        node.current_energy = max(0.0, node.current_energy - E_rx)
    
    return total_energy, True
```

**ç‰¹ç‚¹**ï¼š
- âœ… åŒå‘èƒ½é‡è®¡ç®—ï¼ˆE_tx + E_rxï¼‰
- âœ… èƒ½é‡å……è¶³æ€§æ£€æŸ¥
- âœ… ä¸¤éå¾ªç¯ï¼ˆå…ˆæ£€æŸ¥ï¼Œå†æ‰£é™¤ï¼‰
- âœ… å†…éƒ¨è¾…åŠ©æ–¹æ³•ï¼ˆ`_`å‰ç¼€ï¼‰

---

#### 1.3 `broadcast_commands(physical_center_node, plans, command_packet_size=1)`
**èŒè´£**ï¼šç‰©ç†ä¸­å¿ƒå‘å‚ä¸èŠ‚ç‚¹å¹¿æ’­æ‰§è¡ŒæŒ‡ä»¤ï¼ˆå…¬å¼€æ¥å£ï¼‰

```python
def broadcast_commands(self, physical_center_node, plans, command_packet_size=1):
    """
    ç‰©ç†ä¸­å¿ƒå‘å‚ä¸èŠ‚ç‚¹å¹¿æ’­æ‰§è¡ŒæŒ‡ä»¤
    
    è¿™æ˜¯ç‰©ç†ä¸­å¿ƒçš„ä¸»åŠ¨è¡Œä¸ºä¹‹ä¸€ï¼ˆå¦ä¸€ä¸ªæ˜¯æ¥æ”¶ä¿¡æ¯ä¸ŠæŠ¥ï¼‰ã€‚
    å½“è°ƒåº¦ç®—æ³•ç”Ÿæˆä¼ èƒ½è®¡åˆ’åï¼Œç‰©ç†ä¸­å¿ƒéœ€è¦å‘æ‰€æœ‰å‚ä¸èŠ‚ç‚¹
    ï¼ˆdonorã€receiverã€relayï¼‰ä¸‹å‘æŒ‡ä»¤ï¼Œå‘ŠçŸ¥å®ƒä»¬æ‰§è¡Œä¼ èƒ½ã€‚
    
    åŠŸèƒ½ï¼š
    1. æ”¶é›†éœ€è¦é€šçŸ¥çš„èŠ‚ç‚¹ï¼ˆè‡ªåŠ¨å»é‡ï¼‰
    2. è®¡ç®—é€šä¿¡èƒ½é‡ï¼ˆåŒå‘ï¼šE_tx + E_rxï¼‰
    3. æ£€æŸ¥ä¸­å¿ƒèƒ½é‡æ˜¯å¦è¶³å¤Ÿ
    4. æ‰£é™¤åŒå‘èƒ½é‡
    5. è¿”å›æ‰§è¡Œç»“æœ
    
    :return: (total_energy, success, affected_nodes)
    """
    if physical_center_node is None or not plans:
        return 0.0, True, []
    
    # 1. æ”¶é›†éœ€è¦é€šçŸ¥çš„èŠ‚ç‚¹ï¼ˆå»é‡ï¼‰
    notified_nodes = self._collect_command_recipients(plans)
    
    # 2. è®¡ç®—å¹¶æ‰£é™¤èƒ½é‡
    total_energy, success = self._execute_broadcast(
        physical_center_node, 
        notified_nodes, 
        command_packet_size
    )
    
    # 3. è®°å½•æ—¥å¿—
    if success:
        self._log(f"[NodeInfoManager] æŒ‡ä»¤å¹¿æ’­æˆåŠŸï¼šé€šçŸ¥ {len(notified_nodes)} ä¸ªèŠ‚ç‚¹ï¼Œ"
                 f"æ€»èƒ½é‡ {total_energy:.4f}J")
    else:
        self._log(f"[NodeInfoManager] æŒ‡ä»¤å¹¿æ’­å¤±è´¥ï¼šç‰©ç†ä¸­å¿ƒèƒ½é‡ä¸è¶³")
    
    return total_energy, success, list(notified_nodes)
```

**ç‰¹ç‚¹**ï¼š
- âœ… å…¬å¼€æ¥å£ï¼ˆæ—  `_` å‰ç¼€ï¼‰
- âœ… å®Œæ•´çš„æ–‡æ¡£è¯´æ˜
- âœ… è¿”å›å—å½±å“èŠ‚ç‚¹åˆ—è¡¨
- âœ… å†…ç½®æ—¥å¿—è®°å½•

---

### 2. EnergySimulation é‡æ„

#### 2.1 `calculate_command_downlink_energy(physical_center, plans)` (ç®€åŒ–ç‰ˆ)
**èŒè´£**ï¼šå§”æ‰˜ç»™ NodeInfoManager æ‰§è¡Œ

```python
def calculate_command_downlink_energy(self, physical_center, plans):
    """
    è®¡ç®—æŒ‡ä»¤ä¸‹å‘çš„èƒ½é‡æ¶ˆè€—ï¼ˆå§”æ‰˜ç»™NodeInfoManagerï¼‰
    
    ç‰©ç†ä¸­å¿ƒéœ€è¦å‘æ‰€æœ‰å‚ä¸ä¼ èƒ½çš„èŠ‚ç‚¹ä¸‹å‘æŒ‡ä»¤ï¼Œå‘ŠçŸ¥å®ƒä»¬æ‰§è¡Œä¼ èƒ½è®¡åˆ’ã€‚
    è¯¥æ–¹æ³•å§”æ‰˜ç»™NodeInfoManager.broadcast_commands()æ‰§è¡Œã€‚
    
    :param physical_center: ç‰©ç†ä¸­å¿ƒèŠ‚ç‚¹
    :param plans: ä¼ èƒ½è®¡åˆ’åˆ—è¡¨
    :return: (total_energy, success) - æ€»èƒ½é‡æ¶ˆè€—å’Œæ˜¯å¦æˆåŠŸ
    """
    if not self.enable_command_downlink or physical_center is None:
        return 0.0, True
    
    if not plans:
        return 0.0, True
    
    # è·å–NodeInfoManager
    nim = None
    if hasattr(self.network, 'adcr_link') and self.network.adcr_link:
        nim = getattr(self.network.adcr_link, 'vc', None)
    elif hasattr(self.network, 'path_info_collector') and self.network.path_info_collector:
        nim = getattr(self.network.path_info_collector, 'vc', None)
    
    if nim is None:
        print("[æŒ‡ä»¤ä¸‹å‘] è­¦å‘Šï¼šæœªæ‰¾åˆ°NodeInfoManagerï¼Œè·³è¿‡æŒ‡ä»¤ä¸‹å‘")
        return 0.0, True
    
    # å§”æ‰˜ç»™NodeInfoManageræ‰§è¡Œ
    total_energy, success, affected_nodes = nim.broadcast_commands(
        physical_center, 
        plans, 
        self.command_packet_size
    )
    
    # æ‰“å°ç»“æœ
    if success:
        print(f"[æŒ‡ä»¤ä¸‹å‘] é€šçŸ¥ {len(affected_nodes)} ä¸ªèŠ‚ç‚¹ï¼Œæ€»èƒ½é‡: {total_energy:.4f}J")
    else:
        print(f"[æŒ‡ä»¤ä¸‹å‘] è­¦å‘Šï¼šç‰©ç†ä¸­å¿ƒèƒ½é‡ä¸è¶³ï¼Œæœ¬è½®ä¼ èƒ½å–æ¶ˆ")
    
    return total_energy, success
```

**ç‰¹ç‚¹**ï¼š
- âœ… ç®€æ´æ¸…æ™°ï¼Œç›´æ¥å§”æ‰˜ç»™ NodeInfoManager
- âœ… å†…è”è·å– NodeInfoManagerï¼ˆæ— éœ€å•ç‹¬æ–¹æ³•ï¼‰
- âœ… æ—  NodeInfoManager æ—¶æ‰“å°è­¦å‘Šå¹¶è·³è¿‡

---

## âœ… æµ‹è¯•éªŒè¯

### æµ‹è¯•1ï¼šNodeInfoManager.broadcast_commands()
**æµ‹è¯•åœºæ™¯**ï¼šç›´æ¥æµ‹è¯•NodeInfoManagerçš„å¹¿æ’­åŠŸèƒ½

**ç»“æœ**ï¼š
```
âœ… æµ‹è¯•é€šè¿‡
- æˆåŠŸæ”¶é›†3ä¸ªèŠ‚ç‚¹ï¼ˆdonor, receiver, relayï¼‰
- æ­£ç¡®è®¡ç®—æ€»èƒ½é‡ï¼š0.6146J
- æ­£ç¡®æ‰£é™¤åŒå‘èƒ½é‡ï¼ˆä¸­å¿ƒã€donorã€receiverã€relayï¼‰
```

---

### æµ‹è¯•2ï¼šEnergySimulationå§”æ‰˜ç»™NodeInfoManager
**æµ‹è¯•åœºæ™¯**ï¼šä½¿ç”¨ADCRç½‘ç»œï¼Œæµ‹è¯•å§”æ‰˜æœºåˆ¶

**ç»“æœ**ï¼š
```
âœ… æµ‹è¯•é€šè¿‡
- æˆåŠŸä»network.adcr_link.vcè·å–NodeInfoManager
- æˆåŠŸå§”æ‰˜ç»™NodeInfoManager.broadcast_commands()
- æ­£ç¡®è®¡ç®—å¹¶æ‰£é™¤èƒ½é‡
```

---

### æµ‹è¯•3ï¼šæ— NodeInfoManageræƒ…å†µå¤„ç†
**æµ‹è¯•åœºæ™¯**ï¼šæ— ADCRã€æ— PathCollectorçš„ç½‘ç»œ

**ç»“æœ**ï¼š
```
âœ… æµ‹è¯•é€šè¿‡
- æ­£ç¡®æ£€æµ‹åˆ°æ— NodeInfoManager
- æ‰“å°è­¦å‘Šå¹¶è·³è¿‡æŒ‡ä»¤ä¸‹å‘
- ä¸å½±å“æ­£å¸¸æµç¨‹
```

---

## ğŸ“Š é‡æ„å‰åå¯¹æ¯”

| æ–¹é¢ | é‡æ„å‰ | é‡æ„å |
|------|--------|--------|
| **èŒè´£åˆ†é…** | EnergySimulationè´Ÿè´£ä¸€åˆ‡ | NodeInfoManagerè´Ÿè´£æŒ‡ä»¤ï¼ŒSimulationè´Ÿè´£è°ƒåº¦ |
| **å°è£…æ€§** | è¾ƒå·®ï¼ˆé€»è¾‘åˆ†æ•£ï¼‰ | å¥½ï¼ˆé›†ä¸­åœ¨NodeInfoManagerï¼‰ |
| **å¯è¯»æ€§** | ä¸€èˆ¬ | å¼ºï¼ˆ`nim.broadcast_commands`å¾ˆç›´è§‚ï¼‰ |
| **å¯æµ‹è¯•æ€§** | ä¸€èˆ¬ | å¥½ï¼ˆå¯ä»¥ç‹¬ç«‹æµ‹è¯•broadcastï¼‰ |
| **ä»£ç å¤ç”¨** | å·®ï¼ˆé€»è¾‘å›ºå®šåœ¨Simulationï¼‰ | å¥½ï¼ˆå…¶ä»–åœ°æ–¹ä¹Ÿèƒ½ç”¨broadcastï¼‰ |
| **çµæ´»æ€§** | ä¸€èˆ¬ | å¼ºï¼ˆå¯ä»¥æ‰©å±•ä¸åŒçš„å¹¿æ’­ç­–ç•¥ï¼‰ |
| **OOPåŸåˆ™** | è¿åå•ä¸€èŒè´£ | ç¬¦åˆå•ä¸€èŒè´£ã€é«˜å†…èšä½è€¦åˆ |

---

## ğŸ¯ é‡æ„æˆæœ

### æ ¸å¿ƒæ”¹è¿›

1. **èŒè´£æ¸…æ™°**ï¼š
   - `NodeInfoManager`ï¼šè´Ÿè´£ç‰©ç†ä¸­å¿ƒçš„æ‰€æœ‰è¡Œä¸ºï¼ˆæ¥æ”¶ä¿¡æ¯ã€ä¸‹å‘æŒ‡ä»¤ã€ç®¡ç†ä¿¡æ¯è¡¨ï¼‰
   - `EnergySimulation`ï¼šè´Ÿè´£æ•´ä½“æµç¨‹æ§åˆ¶å’Œé…ç½®ç®¡ç†

2. **å°è£…æ€§å¥½**ï¼š
   - æ‰€æœ‰æŒ‡ä»¤ä¸‹å‘ç›¸å…³é€»è¾‘éƒ½åœ¨ `NodeInfoManager` ä¸­
   - é€šè¿‡ `broadcast_commands()` å…¬å¼€æ¥å£æš´éœ²åŠŸèƒ½

3. **å¯æ‰©å±•æ€§å¼º**ï¼š
   - å¯ä»¥è½»æ¾æ·»åŠ ä¸åŒçš„å¹¿æ’­ç­–ç•¥ï¼ˆå•æ’­ã€ç»„æ’­ç­‰ï¼‰
   - å¯ä»¥åœ¨å…¶ä»–åœ°æ–¹å¤ç”¨ `broadcast_commands()`

4. **ç¬¦åˆè®¾è®¡åŸåˆ™**ï¼š
   - **å•ä¸€èŒè´£**ï¼šæ¯ä¸ªç±»è´Ÿè´£è‡ªå·±çš„äº‹
   - **é«˜å†…èš**ï¼šç›¸å…³åŠŸèƒ½èšé›†åœ¨ä¸€èµ·
   - **ä½è€¦åˆ**ï¼šé€šè¿‡æ¥å£äº¤äº’

---

## ğŸ“ ä¿®æ”¹æ–‡ä»¶æ¸…å•

### æ ¸å¿ƒä»£ç ï¼ˆ2ä¸ªæ–‡ä»¶ï¼‰

1. **`src/acdr/physical_center.py`**
   - æ–°å¢ï¼š`_collect_command_recipients()`
   - æ–°å¢ï¼š`_execute_broadcast()`
   - æ–°å¢ï¼š`broadcast_commands()`

2. **`src/core/energy_simulation.py`**
   - ç®€åŒ–ï¼š`calculate_command_downlink_energy()`ï¼ˆå§”æ‰˜ç»™NodeInfoManagerï¼‰
   - åˆ é™¤ï¼šå‘åå…¼å®¹çš„è¾…åŠ©æ–¹æ³•ï¼ˆæ›´ç®€æ´ï¼‰

---

## ğŸ‰ æ€»ç»“

**é‡æ„æˆåŠŸå®Œæˆï¼**

é€šè¿‡å°†æŒ‡ä»¤ä¸‹å‘åŠŸèƒ½ä» `EnergySimulation` è¿ç§»åˆ° `NodeInfoManager`ï¼Œæˆ‘ä»¬å®ç°äº†ï¼š
- âœ… æ›´æ¸…æ™°çš„èŒè´£åˆ†ç¦»
- âœ… æ›´å¥½çš„é¢å‘å¯¹è±¡è®¾è®¡
- âœ… æ›´å¼ºçš„å¯æ‰©å±•æ€§
- âœ… æ›´ç®€æ´çš„ä»£ç 

æ‰€æœ‰æµ‹è¯•é€šè¿‡ï¼ŒåŠŸèƒ½æ­£å¸¸ï¼Œæ¶æ„æ›´åŠ åˆç†ï¼

---

**æ—¥æœŸ**ï¼š2025-10-28  
**çŠ¶æ€**ï¼šâœ… å®Œæˆ

