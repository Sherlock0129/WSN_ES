# ADCR能耗结算流程图

## 三阶段能耗结算架构

```
┌─────────────────────────────────────────────────────────────────────────┐
│                     ADCR 能耗结算三阶段流程                              │
└─────────────────────────────────────────────────────────────────────────┘

时间轴 t：满足重聚类条件 (t - last_round_t >= round_period)

┌──────────────────────────────────────────────────────────────────────┐
│  阶段 0：分簇决策（基于当前能量状态，不扣能）                        │
├──────────────────────────────────────────────────────────────────────┤
│  1. 计算虚拟中心                                                      │
│  2. 估计最优簇数 K*                                                   │
│  3. 选择簇头 (基于 current_energy)                                    │
│  4. 执行成簇 (基于距离和能量)                                         │
│  5. 规划上报路径                                                      │
└──────────────────────────────────────────────────────────────────────┘
                              ↓
┌──────────────────────────────────────────────────────────────────────┐
│  阶段 1：簇内通信能耗结算（新增）                                     │
├──────────────────────────────────────────────────────────────────────┤
│                                                                       │
│   簇 1                    簇 2                    簇 3                │
│   ┌────┐                  ┌────┐                  ┌────┐             │
│   │ M1 │──┐               │ M4 │──┐               │ M7 │──┐          │
│   └────┘  │               └────┘  │               └────┘  │          │
│   ┌────┐  │  基础数据     ┌────┐  │  基础数据     ┌────┐  │          │
│   │ M2 │──┼─────────→     │ M5 │──┼─────────→     │ M8 │──┼──...     │
│   └────┘  │  (B_base)     └────┘  │  (B_base)     └────┘  │          │
│   ┌────┐  ↓               ┌────┐  ↓               ┌────┐  ↓          │
│   │ M3 │→ ●CH1            │ M6 │→ ●CH2            │ M9 │→ ●CH3       │
│   └────┘  双向扣能         └────┘  双向扣能         └────┘  双向扣能   │
│                                                                       │
│   能耗记录：                                                          │
│   - type: "intra_cluster"                                            │
│   - hop: (member_id, ch_id)                                          │
│   - E_member: 成员发送能耗                                            │
│   - E_ch: 簇头接收能耗                                                │
│                                                                       │
└──────────────────────────────────────────────────────────────────────┘
                              ↓
┌──────────────────────────────────────────────────────────────────────┐
│  阶段 2：簇间路径能耗结算（原有，已增强）                             │
├──────────────────────────────────────────────────────────────────────┤
│                                                                       │
│   聚合数据上报（多跳路径）                                            │
│                                                                       │
│   ●CH1 ──────→ Node_A ──────→ Anchor                                 │
│         聚合数据        聚合数据                                       │
│         双向扣能        双向扣能                                       │
│                                                                       │
│   ●CH2 ──────────────────────→ Anchor                                │
│              聚合数据（直接到锚点）                                     │
│              双向扣能                                                  │
│                                                                       │
│   ●CH3 ──→ Node_B ──→ Node_C ──→ Anchor                              │
│        聚合数据  聚合数据  聚合数据                                     │
│        双向扣能  双向扣能  双向扣能                                     │
│                                                                       │
│   能耗记录：                                                          │
│   - type: "inter_cluster"                                            │
│   - hop: (u.node_id, v.node_id)                                      │
│   - E_tx: 发送端能耗                                                  │
│   - E_rx: 接收端能耗                                                  │
│                                                                       │
└──────────────────────────────────────────────────────────────────────┘
                              ↓
┌──────────────────────────────────────────────────────────────────────┐
│  阶段 3：虚拟跳能耗结算（原有）                                       │
├──────────────────────────────────────────────────────────────────────┤
│                                                                       │
│                         ★ 虚拟中心 (无限能量)                         │
│                              ↑                                        │
│                              │ 虚拟跳                                 │
│                              │ (仅发送端扣能)                          │
│                              │                                        │
│                           Anchor                                      │
│                        (最靠近中心)                                    │
│                                                                       │
│   能耗记录：                                                          │
│   - type: "virtual_hop"                                              │
│   - hop: (anchor_id, "VIRTUAL")                                      │
│   - E_tx_only: 仅发送端能耗                                           │
│   - data_size: 聚合数据量                                             │
│   - cluster_size: 簇大小                                              │
│                                                                       │
└──────────────────────────────────────────────────────────────────────┘

═══════════════════════════════════════════════════════════════════════

能耗统计输出示例：

[ADCR-DEBUG] Phase 1: Settling intra-cluster communication energy
[ADCR-DEBUG] Intra-cluster communication: 27 hops, total energy: 180.50J
[ADCR-DEBUG] Phase 2: Settling cluster head to virtual center path energy
[ADCR-DEBUG] Processing 5 upstream paths
[ADCR-DEBUG] Inter-cluster paths: 8 hops, total energy: 95.30J
[ADCR-DEBUG] Virtual hops: 5 hops, total energy: 45.20J
[ADCR-DEBUG] Total energy consumption: 321.00J
[ADCR-DEBUG] Total communication records: 40

═══════════════════════════════════════════════════════════════════════
```

## 数据流说明

### 阶段 1：簇内数据收集
- **数据方向**：成员 → 簇头
- **数据量**：`base_data_size`（每个成员的原始采集数据）
- **数据特点**：未压缩的原始传感数据

### 阶段 2：簇间数据转发
- **数据方向**：簇头 → 锚点（可能多跳）
- **数据量**：`aggregated_data_size = base_data_size × cluster_size × aggregation_ratio`
- **数据特点**：簇头聚合处理后的数据（可能压缩）

### 阶段 3：最终上报
- **数据方向**：锚点 → 虚拟中心
- **数据量**：`aggregated_data_size`
- **数据特点**：聚合数据的最终上报

## 能量消耗模式

### 成员节点能量消耗
```
E_total = E_intra_cluster_tx
        = (E_tx + E_rx)/2 + E_sen
```

### 簇头能量消耗
```
E_total = E_intra_cluster_rx × (cluster_size - 1)  ← 接收所有成员数据
        + E_inter_cluster_tx                       ← 发送聚合数据
        或
        + E_virtual_hop_tx                         ← 直接到虚拟中心
```

### 中继节点能量消耗
```
E_total = E_inter_cluster_rx + E_inter_cluster_tx
```

### 锚点节点能量消耗
```
E_total = E_inter_cluster_rx  ← 接收簇头数据
        + E_virtual_hop_tx    ← 发送到虚拟中心
```

## 关键特性

### ✅ 能量均衡机制
- 簇头能量消耗大 → 下轮被选为簇头概率降低 → 实现簇头轮换

### ✅ 真实性
- 完整模拟了分簇协议的所有通信开销
- 符合实际WSN系统的能耗特征

### ✅ 可控性
- 通过 `consume_energy` 参数可以开关能耗结算
- 通过 `base_data_size` 和 `aggregation_ratio` 调整数据量

### ✅ 可追溯性
- 所有通信记录保存在 `self.last_comms`
- 详细的调试输出便于分析

## 对比：改进前后

| 项目 | 改进前 | 改进后 |
|------|--------|--------|
| 簇内通信 | ❌ 未扣能 | ✅ 完整扣能 |
| 簇头负载 | ⚠️ 低估 | ✅ 准确反映 |
| 能量均衡 | ⚠️ 不够真实 | ✅ 符合实际 |
| 簇头轮换 | ⚠️ 机制不明显 | ✅ 自然形成 |
| 网络寿命 | ⚠️ 高估 | ✅ 真实评估 |
| 总能耗统计 | ⚠️ 不完整 | ✅ 完整准确 |

## 配置示例

```python
# config.json
{
  "simulation": {
    "enable_adcr_link_layer": true,  // 启用ADCR
    "time_steps": 10080              // 7天
  },
  "adcr": {
    "round_period": 1440,            // 每天重聚类
    "consume_energy": true,          // 启用能耗结算
    "base_data_size": 1000000,       // 1Mb基础数据
    "aggregation_ratio": 1.0,        // 聚合比例
    "enable_dynamic_data_size": true // 动态数据量
  }
}
```

## 验证方法

1. **查看调试输出**，确认三个阶段都有能耗记录
2. **检查 `last_comms`**，验证记录的完整性
3. **对比节点能量**，确认簇头能量下降更快
4. **观察簇头轮换**，验证轮换机制是否生效
5. **统计总能耗**，确保与理论计算一致

