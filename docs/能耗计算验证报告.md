# 能量消耗计算验证报告

## 一、验证结果

✅ **所有测试通过**

- ✅ 测试1：能耗计算公式验证 - 通过
- ✅ 测试2：能量平衡验证 - 通过
- ✅ 测试3：多跳传输能耗验证 - 通过

## 二、代码一致性检查

### 2.1 Network.execute_energy_transfer

#### 单跳传输（duration=1和duration>1）
```python
# 正确实现
base_consumption = donor.energy_consumption(receiver, transfer_WET=False)
wet_consumption = donor.E_char * duration  # ✅ 乘以duration
total_consumption = base_consumption + wet_consumption
```

#### 多跳传输（duration=1和duration>1）
```python
# 第一跳（donor）
if transfer_WET:
    base_consumption = sender.energy_consumption(receiver_i, transfer_WET=False)
    wet_consumption = sender.E_char * duration  # ✅ 乘以duration
    total_consumption = base_consumption + wet_consumption
else:
    # 中间跳：不乘以duration ✅
    sender.current_energy -= sender.energy_consumption(receiver_i, transfer_WET=False)
```

### 2.2 NodeInfoManager.apply_energy_transfer_changes

#### 单跳传输
```python
# 正确实现
wet_consumption = donor_info.E_char * duration  # ✅ 乘以duration
energy_consumed = E_com + E_sen + wet_consumption
```

#### 多跳传输
```python
# 第一跳（donor）
if transfer_WET:
    energy_consumed += sender_info.E_char * duration  # ✅ 乘以duration
# 中间跳：不乘以duration ✅
```

## 三、能耗计算公式

### 3.1 完整公式

```
总能耗 = 基础通信能耗 + WET模块能耗
      = (E_com + E_sen) + (E_char × duration)
```

其中：
- **基础通信能耗**（E_com + E_sen）：
  - E_com = (E_tx + E_rx) / 2
  - E_tx = E_elec × B + epsilon_amp × B × d²
  - E_rx = E_elec × B
  - E_sen = 0.1 J（传感器能耗）
  - **不乘以duration**（一次性通信）

- **WET模块能耗**（E_char × duration）：
  - E_char = 1000 J（默认值，每分钟的功率）
  - **乘以duration**（持续传输duration分钟）

### 3.2 验证示例

#### duration=1时
```
基础通信能耗: 120.10 J
WET模块能耗: 1000.00 J × 1 = 1000.00 J
总能耗: 1120.10 J
```

#### duration=3时
```
基础通信能耗: 120.10 J（不变）
WET模块能耗: 1000.00 J × 3 = 3000.00 J
总能耗: 3120.10 J
```

**比例验证**：
- duration=3的能耗 = 3120.10 J
- duration=1的能耗 = 1120.10 J
- 比例 = 2.79（约3倍，因为WET部分占主导）

## 四、能量平衡验证

### 4.1 传输能量平衡

```
发送能量 = 接收能量 + 损失能量
energy_sent = energy_received + energy_loss
```

**验证**：
- 发送能量：3000.00 J
- 接收能量：450.00 J
- 损失能量：2550.00 J
- ✅ 3000.00 = 450.00 + 2550.00

### 4.2 多跳传输验证

**路径**：node1 → node2 → node3

**第一跳（node1 → node2）**：
- 基础通信能耗：105.10 J
- WET模块能耗：3000.00 J（×3）✅
- 总能耗：3105.10 J

**第二跳（node2 → node3）**：
- 通信能耗：105.10 J（不乘以duration）✅

**验证**：
- ✅ 第一跳WET模块能耗 = E_char × duration
- ✅ 中间跳不乘以duration

## 五、关键修复点总结

### 修复前（错误）
```python
# 错误：WET模块能耗没有乘以duration
donor.current_energy -= donor.energy_consumption(receiver, transfer_WET=True)
# 这会调用SensorNode.energy_consumption，其中E_char是固定值，不乘以duration
```

### 修复后（正确）
```python
# 正确：手动计算，WET模块能耗乘以duration
base_consumption = donor.energy_consumption(receiver, transfer_WET=False)
wet_consumption = donor.E_char * duration  # ✅ 乘以duration
total_consumption = base_consumption + wet_consumption
donor.current_energy -= total_consumption
```

## 六、结论

✅ **能量消耗计算完全正确**

1. ✅ **单跳传输**：WET模块能耗正确乘以duration
2. ✅ **多跳传输**：第一跳WET模块能耗正确乘以duration，中间跳不乘以duration
3. ✅ **Network和NodeInfoManager**：计算逻辑一致
4. ✅ **能量平衡**：发送能量 = 接收能量 + 损失能量
5. ✅ **能耗比例**：duration>1时，能耗正确增加

所有代码位置都已正确实现，测试验证通过。

