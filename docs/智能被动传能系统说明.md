# 智能被动传能系统说明

## 概述

智能被动传能系统是一种基于网络能量状态的自适应能量传输触发机制，相比传统的定时主动传能（每60分钟触发一次），采用更加智能和节能的策略。

## 工作模式对比

### 传统主动传能（passive_mode=False）
- **触发方式**: 定时触发，每60分钟执行一次能量传输
- **优点**: 简单可靠，固定周期
- **缺点**: 
  - 可能在不需要时也进行传能，浪费能量
  - 无法快速响应紧急能量需求
  - 传能频率固定，缺乏灵活性

### 智能被动传能（passive_mode=True）
- **触发方式**: 基于多维度综合决策，按需触发
- **优点**:
  - 节能高效，仅在需要时传能
  - 智能响应网络能量状态变化
  - 支持预测性触发，提前应对能量危机
  - 避免频繁触发造成的振荡
- **缺点**: 计算复杂度略高（但开销可控）

## 智能决策机制

智能被动传能系统综合考虑以下5个关键因素：

### 1. 检查间隔控制 (check_interval)
- **默认值**: 10分钟
- **作用**: 不是每个时间步都检查，而是按间隔检查，降低计算开销
- **建议**: 
  - 快速响应场景：5-10分钟
  - 普通场景：10-20分钟
  - 节能场景：20-30分钟

### 2. 冷却期机制 (cooldown_period)
- **默认值**: 30分钟
- **作用**: 防止频繁触发造成能量振荡，强制两次传能之间的最小间隔
- **原理**: 即使满足触发条件，如果距离上次传能时间小于冷却期，也不会触发
- **建议**: 
  - 设置为检查间隔的2-5倍
  - 典型值：20-60分钟

### 3. 低能量节点比例阈值 (critical_ratio)
- **默认值**: 0.2 (20%)
- **作用**: 当低于阈值的节点数量占比超过此值时触发传能
- **示例**: 
  - 25个节点的网络，当5个或更多节点能量低于阈值时触发
  - critical_ratio=0.2 表示 20% 节点处于低能量状态即触发
- **建议**:
  - 严格场景：0.1-0.15 (10-15%)
  - 均衡场景：0.2-0.3 (20-30%)
  - 宽松场景：0.3-0.4 (30-40%)

### 4. 能量方差阈值 (energy_variance_threshold)
- **默认值**: 0.3
- **作用**: 衡量网络能量分布的不均衡程度（变异系数）
- **计算**: CV = std(energies) / mean(energies)
- **触发条件**: 当变异系数超过阈值，说明能量分布严重不均，需要均衡传能
- **建议**:
  - 严格均衡：0.2-0.25
  - 适度均衡：0.3-0.4
  - 宽松均衡：0.4-0.5

### 5. 预测性窗口 (predictive_window)
- **默认值**: 60分钟
- **作用**: 基于历史能量消耗速率，预测未来一段时间的能量状态
- **原理**: 
  - 记录最近5次检查的平均能量
  - 计算能量下降速率
  - 外推预测未来predictive_window分钟后的能量
  - 如果预测会有大量低能量节点，提前触发传能
- **建议**:
  - 短期预测：30-60分钟
  - 中期预测：60-120分钟
  - 长期预测：120-180分钟

## 综合触发条件

系统会在**满足以下任一条件**时触发能量传输：

1. **严重情况**: 低能量节点比例 > critical_ratio
   - 示例: 20% 以上节点能量不足

2. **能量不均**: 能量变异系数 > energy_variance_threshold
   - 示例: 网络能量分布严重不均衡

3. **预测危机**: 预测未来会出现能量危机
   - 示例: 根据消耗速率，60分钟后将有大量低能量节点

4. **紧急情况**: 存在极低能量节点（低于阈值的50%）
   - 示例: 任何节点能量低于其低阈值的一半（危急状态）

## 配置参数

在 `simulation_config.py` 的 `SimulationConfig` 中配置：

```python
@dataclass
class SimulationConfig:
    # 智能被动传能参数
    passive_mode: bool = True               # 是否启用智能被动传能模式
    check_interval: int = 10                # 智能检查间隔（分钟）
    critical_ratio: float = 0.2             # 低能量节点临界比例（0-1）
    energy_variance_threshold: float = 0.3  # 能量方差阈值
    cooldown_period: int = 30               # 传能冷却期（分钟）
    predictive_window: int = 60             # 预测窗口（分钟）
```

## 使用示例

### 场景1：快速响应型配置
适用于对能量敏感的关键应用

```python
passive_mode = True
check_interval = 5          # 5分钟检查一次
critical_ratio = 0.15       # 15%节点低能量即触发
energy_variance_threshold = 0.25  # 较低的方差阈值
cooldown_period = 15        # 较短的冷却期
predictive_window = 30      # 短期预测
```

### 场景2：均衡型配置（推荐）
平衡响应速度和计算开销

```python
passive_mode = True
check_interval = 10         # 10分钟检查一次
critical_ratio = 0.2        # 20%节点低能量即触发
energy_variance_threshold = 0.3   # 中等方差阈值
cooldown_period = 30        # 中等冷却期
predictive_window = 60      # 中期预测
```

### 场景3：节能型配置
适用于能量充足、追求节能的场景

```python
passive_mode = True
check_interval = 20         # 20分钟检查一次
critical_ratio = 0.3        # 30%节点低能量才触发
energy_variance_threshold = 0.4   # 较高的方差阈值
cooldown_period = 60        # 较长的冷却期
predictive_window = 90      # 长期预测
```

### 场景4：传统定时触发
回退到传统的60分钟定时触发

```python
passive_mode = False        # 禁用被动模式
# 其他参数将被忽略，系统每60分钟触发一次
```

## 运行时监控

系统运行时会输出详细的触发信息：

```
[智能被动传能] 时间步 120: 低能量节点比例=25.00%>20.00%
[智能被动传能] 时间步 350: 能量变异系数=0.352>0.300 | 预测60分钟后将出现能量危机
[智能被动传能] 时间步 580: 存在3个极低能量节点（<阈值50%）
```

## 性能优势

相比传统定时触发，智能被动传能系统可以：

1. **减少不必要的传能次数**: 节省30-50%的传能操作
2. **提高能量利用效率**: 仅在需要时传能，减少损耗
3. **更快响应能量危机**: 紧急情况下可立即触发（无需等到60分钟）
4. **预防性传能**: 通过预测机制提前应对能量不足
5. **避免振荡**: 冷却期机制防止频繁传能

## 调优建议

1. **初始阶段**: 使用默认配置运行，观察触发频率和效果
2. **频率过高**: 增大 cooldown_period 或 critical_ratio
3. **响应过慢**: 减小 check_interval 或 critical_ratio
4. **能量不均**: 降低 energy_variance_threshold
5. **预测不准**: 调整 predictive_window 或增加历史记录

## 技术实现

核心实现在 `src/core/energy_simulation.py` 的 `should_trigger_energy_transfer()` 方法：

- 使用NumPy进行高效的向量化计算
- 维护能量历史队列（最多20条记录）
- 综合多维度指标进行决策
- 返回触发决策和详细原因

## 注意事项

1. **能量阈值设置**: 确保节点的 `low_threshold_energy` 设置合理
2. **网络规模**: 大型网络建议适当增大 check_interval
3. **能量消耗模式**: 根据实际能量消耗速率调整预测窗口
4. **调试模式**: 初期可以减小 cooldown_period 便于观察效果

## 未来扩展

可能的改进方向：

1. 基于机器学习的预测模型
2. 自适应调整阈值参数
3. 考虑网络拓扑的空间相关性
4. 多级触发策略（轻度/中度/重度传能）
5. 与K值自适应联动优化

