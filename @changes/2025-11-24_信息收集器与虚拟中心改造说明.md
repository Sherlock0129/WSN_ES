# 信息收集器与虚拟中心改造说明（2025-11-24）

本文档汇总此次提交中与“节点信息管理器/虚拟中心（VC）”、信息收集器（PathCollector / PeriodicCollector）、以及调度器相关的改动与影响范围。

## 1. 变更概览
- 新增并并行支持两类信息收集器：路径收集器 PathCollector 与定期上报收集器 PeriodicCollector。
- 引入 ensure_virtual_center 闭包，用于惰性、统一地创建/复用虚拟中心（VC），可与 ADCR 的 VC 共享。
- 调度器 create_scheduler 现在能从 ADCR、PathCollector、PeriodicCollector 三处获取节点信息管理器；若都无则通过工厂统一创建 VC。
- 新增极简阈值法调度器 ThresholdScheduler。
- 归档路径与落盘逻辑扩展：若无 ADCR，则对 PathCollector 与 PeriodicCollector 的 VC 分别设置归档路径并执行落盘。
- 物理中心信息管理器 NodeInfoManager 增强：加入对 PeriodicCollector 的能耗统计；能量估算避免覆盖“刚参与传能”的精确信息；新增基于 AoI 的“陈旧信息强制上报”能力（可选）。

---

## 2. 具体文件与改动

### 2.1 src/sim/refactored_main.py

1) create_scheduler 的信息管理器来源扩展
- 注释：从“从 ADCR 或 PathCollector”更新为“从 ADCR、PathCollector 或 PeriodicCollector”。
- 逻辑：
  - 若 network.adcr_link 存在：使用其 vc。
  - elif network.path_info_collector 存在：使用其 vc。
  - elif network.periodic_info_collector 存在：使用其 vc。
  - else：通过 config_manager.create_virtual_center(initial_position=..., enable_logging=False) 统一创建，并 initialize_node_info(...)。
- 意义：统一类型、降低耦合（去除直接 import NodeInfoManager），并优先复用已有 VC。

2) 调度器类型新增
- 新增 ThresholdScheduler（极简阈值法）。当 scheduler_type == "ThresholdScheduler" 时启用，日志提示“使用极简阈值法调度器”。

3) 2.6 信息收集器创建重构（路径 / 定期）
- 新增 ensure_virtual_center() 闭包（惰性 + 缓存）：
  - 若存在 ADCR：直接返回 network.adcr_link.vc（早返回）。
  - 否则按需创建 VC：
    - initial_pos 优先来自 network.get_physical_center()；否则使用常规节点（有 get_regular_nodes 则优先）或全部节点几何中心。
    - 通过 config_manager.create_virtual_center(initial_position=..., enable_logging=True) 创建，并 initialize_node_info(...）。
    - 打印“创建独立虚拟中心，位置: (x, y)”。
- PathCollector 创建：
  - with handle_exceptions("路径信息收集器创建", recoverable=True) 包裹。
  - 调用 config_manager.create_path_collector(ensure_virtual_center(), physical_center)。
- PeriodicCollector 创建（新增）：
  - 新增 enable_periodic_collector 开关。
  - with handle_exceptions("定期信息收集器创建", recoverable=True) 包裹。
  - 调用 config_manager.create_periodic_collector(ensure_virtual_center(), physical_center)。

4) 归档与落盘（仿真前后）
- 设置归档路径：
  - 若存在 ADCR：调用 network.adcr_link.set_archive_path(session_dir)。
  - 否则：
    - 若存在 PathCollector：其 vc.archive_path = <session_dir>/virtual_center_node_info.csv。
    - 若存在 PeriodicCollector：其 vc.archive_path 同上。
- 仿真结束强制落盘 force_flush_archive：
  - 若存在 ADCR：调用 network.adcr_link.vc.force_flush_archive()。
  - 否则：分别对 PathCollector、PeriodicCollector 的 vc 调用 force_flush_archive()。
- 注：若两类收集器共享同一个 VC，设置同一路径并不会造成冲突；若实现上为不同实例，则可能写到同名文件，建议确认工厂是否复用同一 VC 实例。

---

### 2.2 src/info_collection/physical_center.py（来自 physical_center_change.txt）

1) NodeInfoManager 初始化参数新增
- 新增参数 force_report_on_stale: bool = False，并保存到 self.force_report_on_stale。
- 用途：开启“陈旧信息强制上报”（基于 AoI），详见第 4 点。

2) 信息传输能耗与计数扩展，纳入 PeriodicCollector
- info_transmission_energy 结构扩展：加入键 periodic_collector。
- info_transmission_stats 扩展：
  - 新增 total_periodic_collector_energy、periodic_collector_transmission_count。
  - reset() 时同步初始化。
- add_info_transmission_energy(...)：
  - 若节点字典中不存在传输类型键，先创建默认 0.0。
  - 统计中处理 transmission_type == "periodic_collector" 的分支。
- record_transmission(...)：
  - 新增对 "periodic_collector" 的计数。
- get_info_transmission_statistics()/log_info_transmission_statistics()：
  - 输出结构与日志均加入 periodic_collector 的细分与合计。
  - node_breakdown 字典取值改为使用 get(..., 0.0)，避免 KeyError。

3) 能量估算逻辑更稳健，避免覆盖“刚参与传能”的精确信息
- 在周期性估算中：
  - 若节点满足“is_estimated == False 且 arrival_time == current_time”（刚通过能量传输更新能量），则仅更新 t、aoi，不执行能量估算，计入 skipped_count。
  - 日志从“能量估算完成：X 个节点”改为“能量估算完成：X 个节点，跳过 Y 个刚更新的节点”。

4) 能量传输应用不再刷新“到达/AoI”，与“真实信息到达”解耦
- apply_energy_transfer_changes(...)：
  - 仅更新 energy 与 is_estimated=False。
  - 不再更新 arrival_time、record_time、aoi、t（这些字段只在真实上报/到达时刷新）。
  - 避免把“能量传输时刻”误当作“信息上报时刻”。

5) 强制上报逻辑增强
- 原逻辑：仅对“等待中的节点”在条件触发时强制上报。
- 现逻辑：
  - 对已判定超时的 timeout_nodes：
    - 在成功执行后，通过 update_node_info(...) 将其视为一次“真实到达”，刷新 arrival_time/record_time/aoi 等字段。
    - 计数与日志完善，返回值由 len(timeout_nodes) 改为 forced_total（真实成功强制上报的数量）。
  - 若开启 force_report_on_stale：
    - 额外遍历所有未处理节点，按 AoI 与 max_wait_time 判断是否执行“陈旧上报”。
    - 成功后同样通过 update_node_info(...) 生效，并打印“AoI超限强制上报”日志。

---

## 3. 行为变化与影响
- VC 生命周期统一：
  - 通过 ensure_virtual_center 惰性创建并缓存；PathCollector/PeriodicCollector 可共享同一 VC；存在 ADCR 时直接复用 ADCR 的 VC。
- 调度器依赖更灵活：
  - create_scheduler 可从 ADCR、PathCollector、PeriodicCollector 获取 VC；无则由工厂创建，减少直连依赖。
- 统计口径更完整：
  - 能耗与传输计数纳入 PeriodicCollector，日志/报表包含更全面的数据。
- 数据一致性提升：
  - 估算逻辑不再覆盖刚参与能量传输的“确定值”；能量传输不再误刷新信息到达时间与 AoI。
- 可靠性与运维：
  - 路径/定期收集器创建均在可恢复异常的保护下；归档/落盘覆盖两类收集器，日志更细化，便于排查。

---

## 4. 配置与迁移建议
- 若需启用定期上报：
  - 设置 config_manager.periodic_collector_config.enable_periodic_collector = True。
- 如果外部代码直接实例化 NodeInfoManager/VirtualCenter，建议改为使用 config_manager.create_virtual_center(...) 工厂方法，以保持一致性与可测试性。
- 调度器类型：
  - 支持 "ThresholdScheduler"；在配置中将 scheduler_type 设为该值即可。
- 若希望触发 AoI 驱动的强制上报：
  - 在创建 NodeInfoManager/VC 时传入 force_report_on_stale=True（工厂可支持该参数时生效）。

---

## 5. 测试建议清单
- VC 复用
  - 同时启用 PathCollector + PeriodicCollector，无 ADCR：确认 ensure_virtual_center 仅创建一次，两个收集器引用同一 VC。
  - 启用 ADCR：确认收集器复用 ADCR 的 VC；归档/落盘走 ADCR 分支。
- 估算/传能交互
  - 在“刚执行能量传输”的回合内，确认该节点能量维持为确定值，估算不覆盖；AoI 不被误置 0。
- 强制上报
  - 到达等待超时路径：确认强制上报后 arrival_time/aoi 刷新正确，统计计数+1。
  - AoI 陈旧路径（force_report_on_stale=True）：确认满足阈值的节点被触发并记录日志。
- 统计与日志
  - get_info_transmission_statistics 返回结构包含 periodic_collector；log_info_transmission_statistics 输出新增列。
- 归档/落盘
  - 无 ADCR 时，两类收集器的 VC 均设置 archive_path 并能正常 force_flush_archive（若复用同一 VC，行为等价）。

---

## 6. 已知注意点
- ensure_virtual_center 直接使用 network.get_physical_center()；若未来存在不具备该方法的网络实现，需要加上 hasattr 保护以与其他调用处保持一致。
- 当 PathCollector 与 PeriodicCollector 不共享同一 VC 实例时，二者写入同一归档文件名可能带来覆盖/竞争；建议工厂层面确保复用或区分文件名。

以上。
