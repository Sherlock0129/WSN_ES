# 传输时长感知可视化说明

## 📊 概述

当使用 `DurationAwareLyapunovScheduler` 时，系统会自动生成专门的可视化图表，**体现能量传输的持续过程**，而不是瞬时完成。

## 🎨 可视化类型

### 1. ⏱️ 传输时间线图（甘特图）

**文件名**: `transfer_timeline_t{时间}.png`

**展示内容**：
- **上半部分**：甘特图显示每个传输的时间范围
  - 横轴：时间（分钟）
  - 纵轴：传输序号
  - 彩色条：表示传输持续时间
  - 标签：显示 "Donor → Receiver: 能量"
  - 侧边标注：显示每分钟传输量（如"300J/min"）

- **下半部分**：每分钟总能量流动柱状图
  - 显示每分钟全网络的能量流动总量
  - 体现多个传输的叠加效果

**示例解读**：
```
传输1：D5→R3, duration=5分钟, 1500J
传输2：D7→R8, duration=3分钟, 900J

时间线图会显示：
t=60: ████████████████ (传输1, 5分钟)
t=60:     ████████ (传输2, 3分钟)

每分钟能量流：
t=60: 600J (300+300)
t=61: 600J (300+300)
t=62: 600J (300+300)
t=63: 300J (传输2结束)
t=64: 300J (传输2结束)
```

### 2. 🗺️ 带时长标注的传输路径图

**文件名**: `transfer_paths_duration_t{时间}.png`

**展示内容**：
- 网络节点：大小和颜色表示能量状态
- 传输路径：箭头表示传输方向
- **线宽**：传输时长越长，线越粗
- **标签**：显示传输时长和总能量
  - 示例：`"5min\n1500J"`
- 不同receiver用不同颜色区分

**关键特性**：
- 一眼看出哪些是长时间传输（粗线）
- 标签明确显示持续时间
- 体现"传输占用节点资源"的概念

### 3. 📈 传输时长统计图

**文件名**: `duration_statistics.html`（交互式）

**四个子图**：

#### 子图1：使用频率
- 显示各个时长（1-5分钟）被选择的次数
- 了解调度器的偏好

#### 子图2：平均效率
- 显示不同时长的平均传输效率
- 分析：时长越长，效率是否更优？

#### 子图3：总能量传输量
- 显示各时长传输的能量总和
- 评估不同时长的贡献

#### 子图4：单次平均能量
- 显示每次传输的平均能量
- 验证：duration × E_char 的关系

### 4. 🎬 能量流动动画（可选）

**文件名**: `energy_transfer_animation.gif`

**特性**：
- 逐帧显示仿真过程
- 正在传输的路径高亮显示
- 显示传输进度（如"3/5min"）
- 节点能量动态变化

**注意**：动画生成较慢，默认关闭。若需要，取消注释：
```python
# 在 refactored_main.py 第463-464行
create_energy_flow_animation(simulation)
logger.info("✓ 能量传输动画生成完成")
```

## 📐 数据解读

### 示例：duration=5的传输

**配置**：
- E_char = 300J/分钟
- 传输效率 η = 0.8
- 选择duration = 5分钟

**计算**：
```python
energy_sent_total = 5 × 300 = 1500J
energy_delivered = 1500 × 0.8 = 1200J
energy_loss = 1500 - 1200 = 300J
```

**可视化体现**：

1. **时间线图**：显示一个5分钟的条
   ```
   t=60 |████████████████| t=65
        5分钟持续传输
   ```

2. **路径图**：粗箭头（linewidth=6），标签"5min\n1500J"

3. **统计图**：
   - 频率：在"5min"柱子上增加1
   - 总能量：在"5min"柱子上增加1200J
   - 平均能量：取所有5分钟传输的平均值

## 🎯 使用场景

### 场景1：分析调度策略

**问题**：调度器倾向于选择哪个时长？

**查看**：`duration_statistics.html` 的"使用频率"子图

**解读**：
- 如果大多是1分钟 → 倾向短传输，灵活性高
- 如果大多是5分钟 → 倾向长传输，能量传输量大

### 场景2：评估传输效率

**问题**：长时间传输的效率是否更高？

**查看**：`duration_statistics.html` 的"平均效率"子图

**解读**：
- 如果5分钟效率高 → 长传输路径更优
- 如果差异不大 → 时长对效率影响小

### 场景3：理解并发传输

**问题**：多个传输如何重叠？

**查看**：`transfer_timeline_t60.png` 的甘特图

**解读**：
```
传输1: |████████| (t=60-64)
传输2:   |████| (t=61-63)
传输3:       |████████| (t=62-66)

重叠分析：
- t=62-63: 三个传输同时进行
- 能量流动最高点
```

### 场景4：验证节点锁定

**问题**：节点锁定机制是否有效？

**查看**：连续时间点的 `transfer_paths_duration_t{X}.png`

**观察**：
- 如果节点在t=60选择了5分钟传输
- 在t=61,62,63,64的路径图中，该节点不应再出现

## 🔧 自定义可视化

### 修改采样时间点

默认只为前3个和最后1个传输时间点生成图表。若需修改：

```python
# 在 refactored_main.py 第452行
# 改为：所有时间点
sample_times = transfer_times

# 或：每10个时间点采样
sample_times = transfer_times[::10]
```

### 启用动画

```python
# 取消注释 refactored_main.py 第463行
create_energy_flow_animation(simulation)
```

**注意**：
- 动画生成耗时约几分钟
- 文件大小可能较大（几MB）
- 需要安装 pillow：`pip install pillow`

### 调整图表样式

修改 `src/viz/duration_aware_plotter.py`：

```python
# 修改时间线图的颜色
colors = plt.cm.viridis(np.linspace(0, 1, len(plans)))  # 改为viridis色系

# 修改线宽计算
linewidth = 3.0 + 6.0 * (duration / 5.0)  # 加粗路径线

# 修改字体大小
fontsize=12  # 增大标签字体
```

## 📝 常见问题

### Q1: 为什么只有部分时间点有图？

**A**: 默认只为前3个和最后1个时间点生成，避免图片过多。可修改采样策略。

### Q2: 如何确认传输确实持续了5分钟？

**A**: 查看时间线图的甘特图，条形的长度就是持续时间。

### Q3: 节点锁定如何体现？

**A**: 比较连续时间点的路径图，同一节点不应在锁定期间重复出现。

### Q4: 统计图显示为空？

**A**: 可能没有传输记录，检查：
- 是否启用了能量共享？
- 网络节点能量是否均衡（无传输需求）？

### Q5: 动画不生成？

**A**: 确认：
1. 已取消注释相关代码
2. 已安装 pillow：`pip install pillow`
3. 有足够的传输事件（至少几个时间点）

## 🎓 理论对照

### 设计理念

虽然实际能量传输是**瞬时完成**的：
```python
# t=60时刻立即执行
donor.energy -= 1500
receiver.energy += 1200
```

但可视化体现了**概念上的持续过程**：
- 占用节点资源一段时间（节点锁定）
- 累积传输能量（duration × E_char）
- 信息搭便车（传输期间累积信息）

### 与DQN的区别

| 特性 | DQN | DurationAware |
|------|-----|---------------|
| 动作空间 | 1-10分钟（离散） | 1-5分钟（遍历选择） |
| 决策方式 | 神经网络 | Lyapunov优化 |
| 可视化 | 标准可视化 | 专门的时长可视化 |

## 📚 相关文档

- `DQN离散动作调度器说明.md` - DQN调度器原理
- `传输时长优化功能说明.md` - DurationAwareLyapunovScheduler设计
- `快速启动指南.md` - 基本使用方法

## ✅ 总结

传输时长感知的可视化让你能够：

1. **看到过程**：不是瞬间完成，而是持续N分钟
2. **理解权衡**：时长越长 = 能量越多 = 节点锁定越久
3. **分析策略**：调度器如何选择最优时长
4. **验证机制**：节点锁定是否正确实施

🎯 **现在运行仿真，查看生成的图表，体验"分钟级"的能量传输过程！**

